<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard ‚Äì ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</title>

<link rel="icon" type="image/png" href="favicon.png" />

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet" />

<style>
  body {
    font-family:"Prompt",sans-serif;
    background:#e9f2ff;
    margin:0;
  }
  header {
    background:#0d6efd;
    color:#fff;
    padding:16px;
    font-size:20px;
    font-weight:600;
    text-align:center;
  }

  main {
    max-width:1100px;
    background:#fff;
    margin:25px auto;
    padding:28px;
    border-radius:14px;
    box-shadow:0 6px 20px rgba(0,0,0,0.08)
  }

  h2 {
    margin-top:0;
    border-left:6px solid #0d6efd;
    padding-left:12px;
  }

  .count-box {
    background:#e6f7e8;
    padding:14px;
    border-radius:10px;
    border:1px solid #b6dfba;
    color:#085f0a;
    margin-bottom:18px;
    font-size:18px;
  }

  table {
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
  }
  th {
    background:#e5f1ff;
    padding:9px;
    font-size:14px;
  }
  td {
    padding:8px;
    font-size:14px;
    border-bottom:1px solid #e7e7e7;
  }
  tr:nth-child(even){
    background:#f8fbff
  }

  .section {
    margin-top:30px
  }

  .date-filter{
    margin:10px 0;
    display:flex;
    gap:8px;
    align-items:center;
  }
  input[type="date"]{
    padding:8px;
    border:1px solid #cfd8e3;
    border-radius:8px;
  }
  button{
    padding:8px 14px;
    background:#0d6efd;
    color:#fff;
    border:none;
    border-radius:8px;
    cursor:pointer;
  }
  button:hover{background:#0a58ca;}
</style>
</head>

<body>

<header>üìä Dashboard ‚Äì ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</header>

<main>

  <div class="date-filter">
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
    <input type="date" id="filterDate" />
    <button onclick="loadData()">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </div>

  <div id="signedSection" class="section">
    <h2>‚úÖ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ "‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß"</h2>
    <div id="signedCount" class="count-box">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <table>
      <thead>
        <tr>
          <th>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</th>
          <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
          <th>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</th>
          <th>‡∏™‡πà‡∏ß‡∏ô/‡∏ù‡πà‡∏≤‡∏¢</th>
          <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
        </tr>
      </thead>
      <tbody id="signedBody"></tbody>
    </table>
  </div>

  <div id="pendingSection" class="section">
    <h2>üïò ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ "‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô"</h2>
    <div id="pendingCount" class="count-box">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <table>
      <thead>
        <tr>
          <th>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</th>
          <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
          <th>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</th>
          <th>‡∏™‡πà‡∏ß‡∏ô/‡∏ù‡πà‡∏≤‡∏¢</th>
          <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
        </tr>
      </thead>
      <tbody id="pendingBody"></tbody>
    </table>
  </div>

</main>
<!-- =====================  PART 2 : JavaScript  ===================== -->
<script type="module">
/* ===== Firebase Config (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ index.html) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDAYnOCUm4-QKlJGCLOGEGHsUf143K2swc",
  authDomain: "doc-receive-v3.firebaseapp.com",
  projectId: "doc-receive-v3",
  storageBucket: "doc-receive-v3.firebasestorage.app",
  messagingSenderId: "105318430473",
  appId: "1:105318430473:web:0023244038de907be685d8"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

/* ===== Init ===== */
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const docsCol = collection(db, "incoming_docs_real");

/* ===== Helpers ===== */
function pad(n){ return String(n).padStart(2, "0"); }

function setDefaultDateToday() {
  const el = document.getElementById("filterDate");
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = pad(now.getMonth()+1);
  const dd = pad(now.getDate());
  el.value = `${yyyy}-${mm}-${dd}`;
}

function getSelectedDateRange() {
  const el = document.getElementById("filterDate");
  let val = el.value;
  if(!val){
    const now = new Date();
    val = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
  }
  // ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 00:00:00.000 ‚Äì 23:59:59.999 ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
  const start = new Date(`${val}T00:00:00`);
  const end   = new Date(`${val}T23:59:59.999`);
  return { start, end };
}

function fmtDateTimeTH(d){
  try{
    return d.toLocaleString("th-TH", { dateStyle: "short", timeStyle: "medium" });
  }catch(_){
    return d.toLocaleString("th-TH");
  }
}

function renderTable(tbodyId, rows){
  const tbody = document.getElementById(tbodyId);
  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#6c757d">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</td></tr>`;
    return;
  }
  let html = "";
  rows.forEach(r=>{
    html += `
      <tr>
        <td>${r.refno}</td>
        <td>${r.subject}</td>
        <td>${r.from}</td>
        <td>${r.department ?? "-"}</td>
        <td>${r.createdText}</td>
      </tr>`;
  });
  tbody.innerHTML = html;
}

/* ===== Core Loader ===== */
async function loadData(){
  // UI loading
  document.getElementById("signedCount").textContent  = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
  document.getElementById("pendingCount").textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
  document.getElementById("signedBody").innerHTML  = "";
  document.getElementById("pendingBody").innerHTML = "";

  const { start, end } = getSelectedDateRange();

  try{
    // ‡∏î‡∏∂‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ó‡∏≥ client-side filter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ index)
    const snap = await getDocs(query(docsCol, orderBy("createdAt","desc")));

    const signedRows  = [];
    const pendingRows = [];

    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const ts = d.createdAt?.toDate ? d.createdAt.toDate() : null;
      if(!ts) return; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤ (timestamp) ‡∏Ç‡πâ‡∏≤‡∏°

      // filter ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      if(ts < start || ts > end) return;

      const row = {
        refno: d.refno ?? "-",
        subject: d.subject ?? "-",
        from: d.from ?? "-",
        department: d.department ?? "-",
        createdText: fmtDateTimeTH(ts),
      };

      if(d.status === "‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß"){
        signedRows.push(row);
      }else if(d.status === "‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô"){
        pendingRows.push(row);
      }
    });

    // ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
    document.getElementById("signedCount").textContent  =
      `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà "‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${signedRows.length} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á`;
    document.getElementById("pendingCount").textContent =
      `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà "‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${pendingRows.length} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á`;

    renderTable("signedBody",  signedRows);
    renderTable("pendingBody", pendingRows);

  }catch(e){
    console.error(e);
    document.getElementById("signedCount").textContent  = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    document.getElementById("pendingCount").textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
  }
}

/* ===== Boot ===== */
setDefaultDateToday();
loadData();

// ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° Enter ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á date ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
document.getElementById("filterDate").addEventListener("keydown",(e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    loadData();
  }
});
</script>
<!-- ===================  END PART 2  =================== -->
</body>
</html>
