<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard ‚Äì ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</title>

<link rel="icon" type="image/png" href="favicon.png" />

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet" />

<style>
  body {
    font-family:"Prompt",sans-serif;
    background:#e9f2ff;
    margin:0;
  }
  header {
    background:#0d6efd;
    color:#fff;
    padding:16px;
    font-size:20px;
    font-weight:600;
    text-align:center;
  }

  main {
    max-width:1100px;
    background:#fff;
    margin:25px auto;
    padding:28px;
    border-radius:14px;
    box-shadow:0 6px 20px rgba(0,0,0,0.08)
  }

  h2 {
    margin-top:0;
    border-left:6px solid #0d6efd;
    padding-left:12px;
  }

  .count-box {
    background:#e6f7e8;
    padding:14px;
    border-radius:10px;
    border:1px solid #b6dfba;
    color:#085f0a;
    margin-bottom:18px;
    font-size:18px;
  }

  table {
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
  }
  th {
    background:#e5f1ff;
    padding:9px;
    font-size:14px;
  }
  td {
    padding:8px;
    font-size:14px;
    border-bottom:1px solid #e7e7e7;
  }
  tr:nth-child(even){
    background:#f8fbff
  }

  .section {
    margin-top:30px
  }

  .date-filter{
    margin:10px 0;
    display:flex;
    gap:8px;
    align-items:center;
  }
  input[type="date"]{
    padding:8px;
    border:1px solid #cfd8e3;
    border-radius:8px;
  }
  button{
    padding:8px 14px;
    background:#0d6efd;
    color:#fff;
    border:none;
    border-radius:8px;
    cursor:pointer;
  }
  button:hover{background:#0a58ca;}
</style>
</head>

<body>

<header>üìä Dashboard ‚Äì ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</header>

<main>

  <div class="date-filter">
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
    <input type="date" id="filterDate" />
    <button onclick="loadData()">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </div>

  <div id="signedSection" class="section">
    <h2>‚úÖ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ "‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß"</h2>
    <div id="signedCount" class="count-box">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <table>
      <thead>
        <tr>
          <th>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</th>
          <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
          <th>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</th>
          <th>‡∏™‡πà‡∏ß‡∏ô/‡∏ù‡πà‡∏≤‡∏¢</th>
          <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
        </tr>
      </thead>
      <tbody id="signedBody"></tbody>
    </table>
  </div>

  <div id="pendingSection" class="section">
    <h2>üïò ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ "‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô"</h2>
    <div id="pendingCount" class="count-box">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <table>
      <thead>
        <tr>
          <th>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</th>
          <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
          <th>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</th>
          <th>‡∏™‡πà‡∏ß‡∏ô/‡∏ù‡πà‡∏≤‡∏¢</th>
          <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
        </tr>
      </thead>
      <tbody id="pendingBody"></tbody>
    </table>
  </div>

</main>
<!-- =====================  PART 2 : JavaScript  ===================== -->
<script type="module">
/* ===== Firebase Config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDAYnOCUm4-QKlJGCLOGEGHsUf143K2swc",
  authDomain: "doc-receive-v3.firebaseapp.com",
  projectId: "doc-receive-v3",
  storageBucket: "doc-receive-v3.firebasestorage.app",
  messagingSenderId: "105318430473",
  appId: "1:105318430473:web:0023244038de907be685d8"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

/* ===== Firebase Init ===== */
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const docsCol = collection(db, "incoming_docs_real");

/* ===== Helper ===== */
function pad(n){ return String(n).padStart(2,"0"); }

function setDefaultDateToday(){
  const el = document.getElementById("filterDate");
  const d  = new Date();
  el.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function getSelectedDateRange(){
  const el = document.getElementById("filterDate");
  let val = el.value;
  if(!val){
    const d = new Date();
    val = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  const start = new Date(`${val}T00:00:00`);
  const end   = new Date(`${val}T23:59:59.999`);
  return { start, end };
}

function fmt(d){
  return d.toLocaleString("th-TH", { dateStyle:"short", timeStyle:"medium" });
}

function render(tbody, rows){
  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#888">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</td></tr>`;
    return;
  }
  let html="";
  rows.forEach(r=>{
    html += `
      <tr>
        <td>${r.refno}</td>
        <td>${r.subject}</td>
        <td>${r.from}</td>
        <td>${r.department}</td>
        <td>${r.createdText}</td>
      </tr>`;
  });
  tbody.innerHTML = html;
}

/* ===== MAIN LOAD ===== */
async function loadData(){
  const signedBody  = document.getElementById("signedBody");
  const pendingBody = document.getElementById("pendingBody");

  const signedCount  = document.getElementById("signedCount");
  const pendingCount = document.getElementById("pendingCount");

  signedBody.innerHTML = "";
  pendingBody.innerHTML = "";
  signedCount.textContent  = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
  pendingCount.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";

  const { start, end } = getSelectedDateRange();

  try{
    const snap = await getDocs(query(docsCol, orderBy("createdAt","desc")));

    const signedRows  = [];
    const pendingRows = [];

    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const ts = d.createdAt?.toDate?.();
      if(!ts) return;
      if(ts < start || ts > end) return;

      const row = {
        refno   : d.refno ?? "-",
        subject : d.subject ?? "-",
        from    : d.from ?? "-",
        department: d.department ?? "-",
        createdText: fmt(ts),
        status: d.status ?? "-"
      };

      if(row.status === "‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß") signedRows.push(row);
      else if(row.status === "‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô") pendingRows.push(row);
    });

    render(signedBody, signedRows);
    render(pendingBody, pendingRows);

    signedCount.textContent  = `‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ${signedRows.length} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á`;
    pendingCount.textContent = `‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô: ${pendingRows.length} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á`;

  }catch(e){
    console.error(e);
    signedCount.textContent  = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
    pendingCount.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
  }
}

/* ===== EVENT ===== */
document.getElementById("loadBtn").addEventListener("click", ()=>{
  loadData();
});

document.getElementById("filterDate").addEventListener("change", ()=>{
  loadData();
});

document.getElementById("filterDate").addEventListener("keydown",(e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    loadData();
  }
});

/* ===== RUN FIRST ===== */
setDefaultDateToday();
loadData();

</script>
