<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ ‚Äì Version 3</title>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet" />

<style>
  body {font-family:"Prompt",sans-serif;background:#e9f2ff;margin:0}
  header {background:#0d6efd;color:#fff;padding:18px;font-size:20px;font-weight:600;text-align:center}
  main {max-width:1100px;background:#fff;margin:25px auto;padding:28px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
  .row {display:grid;grid-template-columns:1fr 1fr;gap:15px}
  label {font-size:14px;color:#003366;font-weight:500}
  input,select {width:100%;padding:10px;border:1px solid #cfd8e3;border-radius:8px;font-size:14px;background:#fff;transition:.2s}
  input:focus,select:focus {border-color:#0d6efd;box-shadow:0 0 5px rgba(13,110,253,0.3)}
  button {padding:10px;background:#0d6efd;border:none;color:#fff;border-radius:10px;font-size:15px;cursor:pointer}
  button:hover {background:#0a58ca}
  table {width:100%;border-collapse:collapse;}
  th {background:#e5f1ff;padding:9px;font-size:14px;position:sticky;top:0}
  td {padding:8px;font-size:14px;border-bottom:1px solid #e7e7e7}
  tr:nth-child(even){background:#f8fbff}
  .filter-row {display:flex;gap:8px;margin:16px 0;flex-wrap:wrap}
  #dashboard {background:#f1f8ff;padding:14px;border-radius:12px;margin-top:20px;border:1px solid #cfe2ff}

  .table-wrapper{
    max-height: 500px;
    overflow-y: auto;
    border-radius: 10px;
    border:1px solid #ddd;
    margin-top: 18px;
  }
</style>
</head>

<body>
<header>üìÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî Version 3</header>

<main>

  <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</h3>

  <form id="docForm">

    <div class="row">
      <div>
        <label>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</label>
        <input id="refno" placeholder="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" disabled />
      </div>

      <div>
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</label>
        <input type="date" id="date" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>‡πÄ‡∏ß‡∏•‡∏≤</label>
        <input type="time" id="time" />
      </div>

      <div>
        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</label>
        <select id="urgency">
          <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô">‡∏î‡πà‡∏ß‡∏ô</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å">‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î">‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</label>
        <input type="text" id="from" />
      </div>

      <div>
        <label>‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö</label>
        <select id="secret">
          <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">üîí ‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
          <option value="‡∏•‡∏±‡∏ö">üîí ‡∏•‡∏±‡∏ö</option>
          <option value="‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å">üîíüîí ‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å</option>
          <option value="‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î">üîíüîíüîí ‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
        </select>
      </div>
    </div>

    <label>‡∏™‡πà‡∏ß‡∏ô/‡∏ù‡πà‡∏≤‡∏¢</label>
    <select id="department">
      <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô/‡∏ù‡πà‡∏≤‡∏¢ ‚Äî</option>
      <option value="‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏±‡∏ì‡∏ë‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏±‡∏ì‡∏ë‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</option>
      <option value="‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á">‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</option>
      <option value="‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏ì‡πå">‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏ì‡πå</option>
      <option value="‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏á">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏á</option>
      <option value="‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏á 1">‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏á 1</option>
      <option value="‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏á 2">‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏á 2</option>
      <option value="‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£">‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
    </select>

    <label>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
    <input type="text" id="subject" />

    <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
    <input type="text" id="note" />

    <button type="button" id="saveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

  </form>

  <input type="text" id="searchBox" placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö / ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠ / ‡∏™‡πà‡∏ß‡∏ô/‡∏ù‡πà‡∏≤‡∏¢)" style="width:100%;margin-top:18px"/>

  <div class="filter-row">
    <button id="filterAll">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button id="filterWait">‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠</button>
    <button id="filterPending">‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô</button>
    <button id="filterSigned">‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
    <button id="filterReturn">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>

    <!-- ‚úÖ filter department -->
    <select id="filterDept">
      <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô/‡∏ù‡πà‡∏≤‡∏¢ ‚Äî</option>
      <option value="‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏±‡∏ì‡∏ë‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏±‡∏ì‡∏ë‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</option>
      <option value="‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á">‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</option>
      <option value="‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏ì‡πå">‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏ì‡πå</option>
      <option value="‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏á">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏á</option>
      <option value="‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏á 1">‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏á 1</option>
      <option value="‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏á 2">‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏á 2</option>
      <option value="‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£">‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
    </select>
  </div>

  <div class="table-wrapper">
    <table id="docTable">
      <thead>
        <tr>
          <th>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
          <th>‡∏™‡πà‡∏ß‡∏ô/‡∏ù‡πà‡∏≤‡∏¢</th>
          <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
          <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</th>
          <th>‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö</th>
          <th>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</th>
          <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <button id="exportBtn" style="margin-top:16px">üì§ Export Excel</button>

</main>

<script type="module">

/* ‚úÖ Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyDAYnOCUm4-QKlJGCLOGEGHsUf143K2swc",
  authDomain: "doc-receive-v3.firebaseapp.com",
  projectId: "doc-receive-v3",
  storageBucket: "doc-receive-v3.firebasestorage.app",
  messagingSenderId: "105318430473",
  appId: "1:105318430473:web:0023244038de907be685d8"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, serverTimestamp, Timestamp,
  query, orderBy, onSnapshot, getDocs, updateDoc,
  doc, arrayUnion, limit
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const docsCol = collection(db, "incoming_docs_real");

function randomSuffix(len = 4) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let out = "";
  for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random()*chars.length)];
  return out;
}

/* ‚úÖ Running Number */
async function generateRefNo(){
  const yearTH = new Date().getFullYear()+543;
  const qLast = query(docsCol, orderBy("refno","desc"), limit(1));
  const snap = await getDocs(qLast);
  let next=1;
  if(!snap.empty){
    const last = snap.docs[0].data().refno || "";
    const [seq,y] = (last+"").split("/");
    if(parseInt(y)===yearTH){ next = (parseInt(seq)||0)+1; }
  }
  return String(next).padStart(3,"0")+"/"+yearTH+"-"+randomSuffix(4);
}

/* ‚úÖ reset form */
function resetForm(){
  document.getElementById("docForm").reset();
  const now = new Date();
  document.getElementById("date").value = now.toISOString().slice(0,10);
  document.getElementById("time").value = now.toTimeString().slice(0,5);
}

/* ‚úÖ Save */
document.getElementById("saveBtn").onclick = async ()=>{
  const date = date.value;
  const time = time.value;
  const subject = subject.value.trim();
  const from = from.value.trim();
  const department = document.getElementById("department").value;
  const urgency = urgency.value;
  const secret  = secret.value;
  const note    = note.value.trim();

  if(!date || !time || !subject || !from){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡πÄ‡∏ß‡∏•‡∏≤ / ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠");
    return;
  }

  try{
    const refno = await generateRefNo();
    const docRef = await addDoc(docsCol,{
      refno, date, time, subject, urgency, secret, from, department, note,
      status:"‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠",
      createdAt: serverTimestamp(),
      statusHistory:[]
    });

    await updateDoc(docRef,{
      statusHistory: arrayUnion({status:"‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠",updatedAt:Timestamp.now()})
    });

    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    resetForm();
  }catch(e){
    console.error(e);
    alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
};

/* ‚úÖ update status */
window.changeStatus = async (id,newStatus)=>{
  try{
    const ref = doc(db,"incoming_docs_real",id);
    await updateDoc(ref,{
      status:newStatus,
      statusHistory: arrayUnion({status:newStatus,updatedAt:Timestamp.now()})
    });
    alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß");
  }catch(e){
    alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
};

let currentFilterStatus="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
let currentFilterDept="";

/* ‚úÖ LOAD DATA */
function loadData(){
  const q = query(docsCol, orderBy("createdAt","desc"));
  onSnapshot(q,(snap)=>{
    let html="";
    const keyword = document.getElementById("searchBox").value.toLowerCase();

    snap.forEach(docSnap=>{
      const d = docSnap.data();

      if(currentFilterStatus!=="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" && d.status!==currentFilterStatus) return;
      if(currentFilterDept && d.department!==currentFilterDept) return;

      const allText = `${d.refno} ${d.subject} ${d.from} ${d.note} ${d.department}`.toLowerCase();
      if(keyword && !allText.includes(keyword)) return;

      html += `
      <tr>
        <td>${d.refno}</td>
        <td>${d.date}</td>
        <td>${d.time}</td>
        <td>${d.department??"-"}</td>
        <td>${d.subject}</td>
        <td>${d.urgency}</td>
        <td>${d.secret}</td>
        <td>${d.from}</td>
        <td>${d.note}</td>
        <td>${d.status}</td>
        <td>${d.createdAt?.toDate? d.createdAt.toDate().toLocaleString("th-TH"):"-"}</td>
        <td>
          <select onchange="changeStatus('${docSnap.id}', this.value)">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
            <option value="‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠">‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠</option>
            <option value="‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô">‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô</option>
            <option value="‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß">‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</option>
          </select>
        </td>
      </tr>
      `;
    });
    document.querySelector("#docTable tbody").innerHTML = html;
  });
}
loadData();

/* ‚úÖ Filter event */
document.getElementById("filterAll").onclick    = ()=>{currentFilterStatus="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";loadData();};
document.getElementById("filterWait").onclick   = ()=>{currentFilterStatus="‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠";loadData();};
document.getElementById("filterPending").onclick= ()=>{currentFilterStatus="‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô";loadData();};
document.getElementById("filterSigned").onclick = ()=>{currentFilterStatus="‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß";loadData();};
document.getElementById("filterReturn").onclick = ()=>{currentFilterStatus="‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";loadData();};

document.getElementById("filterDept").onchange = (e)=>{
  currentFilterDept = e.target.value;
  loadData();
};

document.getElementById("searchBox").oninput = ()=> loadData();

/* ‚úÖ EXPORT */
document.getElementById("exportBtn").onclick = async ()=>{
  const snap = await getDocs(query(docsCol, orderBy("createdAt","desc")));
  let rows=[];
  snap.forEach(docSnap=>{
    const d=docSnap.data();
    let history="-";
    if(d.statusHistory){
      history = d.statusHistory
      .map(x=>`${x.status} (${x.updatedAt?.toDate?.().toLocaleString("th-TH")??"-"})`)
      .join("\n");
    }
    rows.push({
      ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö:d.refno,
      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö:d.date,
      ‡πÄ‡∏ß‡∏•‡∏≤:d.time,
      ‡∏™‡πà‡∏ß‡∏ô‡∏ù‡πà‡∏≤‡∏¢: d.department??"-",
      ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á:d.subject,
      ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠:d.from,
      ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô:d.urgency,
      ‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö:d.secret,
      ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:d.status,
      ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:history,
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠:d.createdAt?.toDate?.().toLocaleString("th-TH")??"-"
    });
  });
  let wb=XLSX.utils.book_new();
  let ws=XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,"incoming_docs_real");
  XLSX.writeFile(wb,"incoming_docs_real.xlsx");
  alert("‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
};
resetForm();

</script>
</body>
</html>
