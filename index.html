<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ ‚Äì Version 3</title>

<style>
  body {
    font-family: "Prompt", sans-serif;
    background: #e9f2ff;
    margin: 0;
  }

  header {
    background: #0d6efd;
    color: #fff;
    padding: 18px;
    font-size: 20px;
    font-weight: 600;
    text-align: center;
  }

  main {
    max-width: 1100px;
    background: #fff;
    margin: 25px auto;
    padding: 28px;
    border-radius: 14px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  }

  .row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  label {
    font-size: 14px;
    color: #003366;
    font-weight: 500;
  }

  input, select {
    width: 100%;
    padding: 10px;
    border: 1px solid #cfd8e3;
    border-radius: 8px;
    font-size: 14px;
    background: #fff;
    transition: 0.2s;
  }

  input:focus, select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 5px rgba(13,110,253,0.3);
  }

  button {
    padding: 10px;
    background: #0d6efd;
    border: none;
    color: #fff;
    border-radius: 10px;
    font-size: 15px;
    cursor: pointer;
  }

  button:hover {
    background: #0a58ca;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 18px;
  }

  th {
    background: #e5f1ff;
    padding: 9px;
    font-size: 14px;
  }

  td {
    padding: 8px;
    font-size: 14px;
    border-bottom: 1px solid #e7e7e7;
  }

  tr:nth-child(even) { background: #f8fbff; }

  .filter-row {
    display: grid;
    grid-template-columns: repeat(5,1fr);
    gap: 8px;
    margin: 16px 0;
  }

  #dashboard {
    background: #f1f8ff;
    padding: 14px;
    border-radius: 12px;
    margin-top: 20px;
    border: 1px solid #cfe2ff;
  }
</style>
</head>

<body>
<header>üìÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî Version 3</header>

<main>

  <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>

  <form id="docForm">

    <div class="row">
      <div>
        <label>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</label>
        <input id="refno" placeholder="‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" disabled />
      </div>

      <div>
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</label>
        <input type="date" id="date" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>‡πÄ‡∏ß‡∏•‡∏≤</label>
        <input type="time" id="time" />
      </div>

      <div>
        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</label>
        <select id="urgency">
          <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô">‡∏î‡πà‡∏ß‡∏ô</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å">‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î">‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</label>
        <input type="text" id="from" />
      </div>

      <div>
        <label>‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö</label>
        <select id="secret">
          <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">üîí ‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
          <option value="‡∏•‡∏±‡∏ö">üîí ‡∏•‡∏±‡∏ö</option>
          <option value="‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å">üîíüîí ‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å</option>
          <option value="‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î">üîíüîíüîí ‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
        </select>
      </div>
    </div>

    <label>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
    <input type="text" id="subject" />

    <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
    <input type="text" id="note" />

    <button type="button" id="saveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

  </form>

  <!-- Search -->
  <input
    type="text"
    id="searchBox"
    placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö / ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠)"
    style="width:100%;margin-top:18px"
  />

  <!-- Filter -->
  <div class="filter-row">
    <button id="filterAll">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button id="filterWait">‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠</button>
    <button id="filterPending">‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô</button>
    <button id="filterSigned">‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
    <button id="filterReturn">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
  </div>

  <!-- Table -->
  <table id="docTable">
    <thead>
      <tr>
        <th>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th>
        <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
        <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
        <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</th>
        <th>‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö</th>
        <th>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</th>
        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="exportBtn" style="margin-top:16px">üì§ Export Excel</button>

  <!-- Dashboard -->
  <div id="dashboard">
    <h3>Dashboard (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô / ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h3>
    <p id="dailyCount">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: -</p>
    <p id="monthlyCount">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: -</p>
  </div>

</main>


<!-- ‚úÖ JS-Firebase (‡∏ï‡πà‡∏≠) -->
<script type="module">

/* ===== 1) ‡πÉ‡∏™‡πà Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ===== */
const firebaseConfig = {
  apiKey: "PASTE_API_KEY_HERE",
  authDomain: "PASTE_AUTH_DOMAIN_HERE",
  projectId: "PASTE_PROJECT_ID_HERE",
  storageBucket: "PASTE_STORAGE_BUCKET_HERE",
  appId: "PASTE_APP_ID_HERE",
};


/* ===== 2) IMPORT FIREBASE ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, serverTimestamp,
  query, orderBy, onSnapshot, updateDoc, doc,
  getDocs, where, Timestamp, limit
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";


/* ===== 3) INIT ===== */
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const docsCol = collection(db, "incoming_docs");


/* ===== 4) DOM ===== */
const tbody = document.querySelector("#docTable tbody");
const btnSave = document.getElementById("saveBtn");
const searchBox = document.getElementById("searchBox");
const exportBtn = document.getElementById("exportBtn");
const dailyEl   = document.getElementById("dailyCount");
const monthlyEl = document.getElementById("monthlyCount");


/* ===== Utility ===== */
const fmtDateTimeTH = (d) =>
  new Intl.DateTimeFormat("th-TH", { dateStyle:"short", timeStyle:"short" }).format(d);

const statusIcon = (s)=>{
  switch(s){
    case "‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠": return "üü°";
    case "‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô": return "üîµ";
    case "‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß": return "üü¢";
    case "‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç": return "üî¥";
    default: return "‚ö™";
  }
};


/* ===== 5) RUNNING NUMBER ===== */
async function generateRefNo(){
  const yearTH = new Date().getFullYear()+543;
  const qLast = query(docsCol, orderBy("refno","desc"), limit(1));
  const snap = await getDocs(qLast);
  let next=1;

  if(!snap.empty){
    const last = snap.docs[0].data().refno || "";
    const [seq,y]= last.split("/");
    if(parseInt(y)===yearTH){
      next = (parseInt(seq)||0)+1;
    }
  }
  return String(next).padStart(3,"0")+"/"+yearTH;
}


/* ===== 6) SAVE ===== */
btnSave.addEventListener("click", async()=>{
  const date    = document.getElementById("date").value;
  const time    = document.getElementById("time").value;
  const subject = document.getElementById("subject").value.trim();
  const urgency = document.getElementById("urgency").value;
  const secret  = document.getElementById("secret").value;
  const from    = document.getElementById("from").value.trim();
  const note    = document.getElementById("note").value.trim();

  if(!date || !time || !subject || !from){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤/‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠");
    return;
  }

  try{
    const refno= await generateRefNo();
    await addDoc(docsCol,{
      refno, date, time, subject, urgency, secret, from, note,
      status:"‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠",
      createdAt: serverTimestamp(),
    });
    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }catch(e){
    console.error(e);
    alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
});


/* ===== 7) TABLE + FILTER + SEARCH ===== */
let cacheDocs=[];
let currentFilter="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";

function renderTable(){
  const kw = (searchBox.value||"").toLowerCase();

  const filtered = cacheDocs
    .filter(({data}) => currentFilter==="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || data.status===currentFilter)
    .filter(({data})=>{
      if(!kw) return true;
      return (
        (data.refno||"").toLowerCase().includes(kw) ||
        (data.subject||"").toLowerCase().includes(kw) ||
        (data.from||"").toLowerCase().includes(kw)
      );
    });

  tbody.innerHTML="";

  filtered.forEach(({id,data,createdText})=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${data.refno||"-"}</td>
      <td>${data.date||"-"}</td>
      <td>${data.time||"-"}</td>
      <td>${data.subject||"-"}</td>
      <td>${data.urgency||"-"}</td>
      <td>${data.secret||"-"}</td>
      <td>${data.from||"-"}</td>
      <td>${data.note||"-"}</td>
      <td>${statusIcon(data.status)} ${data.status}</td>
      <td>${createdText}</td>
      <td>
        <button onclick="updateStatus('${id}','‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô')">‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô</button>
        <button onclick="updateStatus('${id}','‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß')">‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
        <button onclick="updateStatus('${id}','‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç')">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

searchBox.addEventListener("input",renderTable);

document.getElementById("filterAll").onclick     = ()=>{ currentFilter="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"; renderTable(); };
document.getElementById("filterWait").onclick     = ()=>{ currentFilter="‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠"; renderTable(); };
document.getElementById("filterPending").onclick  = ()=>{ currentFilter="‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô"; renderTable(); };
document.getElementById("filterSigned").onclick   = ()=>{ currentFilter="‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß"; renderTable(); };
document.getElementById("filterReturn").onclick   = ()=>{ currentFilter="‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"; renderTable(); };


/* ===== 8) LOAD REALTIME ===== */
const qList = query(docsCol, orderBy("createdAt","desc"));
onSnapshot(qList ,(snap)=>{
  cacheDocs=[];
  snap.forEach((ds)=>{
    const d=ds.data();
    const created = d.createdAt?.toDate?.();
    cacheDocs.push({
      id:ds.id,
      data:d,
      createdText: created? fmtDateTimeTH(created):"-"
    });
  });
  renderTable();
});


/* ===== 9) UPDATE STATUS ===== */
async function _updateStatus(id,newStatus){
  try{
    await updateDoc(doc(db,"incoming_docs",id),{
      status:newStatus
    });
    updateDashboard();
  }catch(e){
    console.error(e);
    alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
}
window.updateStatus=_updateStatus;


/* ===== 10) EXPORT EXCEL ===== */
exportBtn.addEventListener("click",async()=>{
  const snap = await getDocs(qList);
  const rows=[];

  snap.forEach((ds)=>{
    const d=ds.data();
    const created = d.createdAt?.toDate?.();
    rows.push({
      ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö: d.refno,
      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö: d.date,
      ‡πÄ‡∏ß‡∏•‡∏≤: d.time,
      ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: d.subject,
      ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô: d.urgency,
      ‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö: d.secret,
      ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠: d.from,
      ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: d.note,
      ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: d.status,
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: created? fmtDateTimeTH(created):"-"
    });
  });

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Docs");

  XLSX.writeFile(wb,"incoming-docs.xlsx");
});


/* ===== 11) DASHBOARD ===== */
async function updateDashboard(){
  const now=new Date();
  const startDay = new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const startMonth = new Date(now.getFullYear(),now.getMonth(),1);

  const qDay = query(docsCol, where("createdAt", ">=", Timestamp.fromDate(startDay))
