<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ ‚Äì V3</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <!-- Style -->
  <style>
    body {
      font-family: "Prompt", sans-serif;
      background: #f4f8ff;
      margin: 0;
    }

    header {
      background: #0056d6;
      color: #fff;
      padding: 18px;
      font-size: 22px;
      font-weight: 600;
      text-align: center;
    }

    main {
      max-width: 1100px;
      background: #fff;
      margin: 25px auto;
      padding: 25px;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }

    h3 {
      margin-bottom: 15px;
      color: #003a8c;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 10px;
    }

    label {
      font-weight: 600;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccd6e1;
      border-radius: 8px;
      font-size: 14px;
      transition: 0.2s;
    }

    input:focus, select:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 5px rgba(13,110,253,0.3);
      outline: none;
    }

    button {
      background: #0d6efd;
      color: #fff;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      margin-top: 8px;
    }
    button:hover {
      background: #0649c9;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
      font-size: 14px;
    }

    th {
      background: #e9f1ff;
      padding: 10px;
      text-align: center;
    }

    td {
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
    }

    tr:nth-child(even) {
      background: #f7faff;
    }

    .filter-row {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .filter-row button {
      flex: 1;
      min-width: 120px;
      background: #1971f1;
    }

    #dashboard {
      background: #f0f5ff;
      padding: 16px;
      border-radius: 12px;
      margin-top: 20px;
      border: 1px solid #cfe2ff;
    }
  </style>
</head>

<body>

<header>üìÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî V3</header>

<main>

  <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</h3>

  <form id="docForm">

    <div class="row">
      <div>
        <label>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</label>
        <input id="refno" placeholder="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" disabled />
      </div>

      <div>
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</label>
        <input type="date" id="date" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>‡πÄ‡∏ß‡∏•‡∏≤</label>
        <input type="time" id="time" />
      </div>

      <div>
        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</label>
        <select id="urgency">
          <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô">‡∏î‡πà‡∏ß‡∏ô</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å">‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î">‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</label>
        <input id="from" />
      </div>

      <div>
        <label>‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö</label>
        <select id="secret">
          <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
          <option value="‡∏•‡∏±‡∏ö">‡∏•‡∏±‡∏ö</option>
          <option value="‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å">‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å</option>
          <option value="‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î">‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
        </select>
      </div>
    </div>

    <label>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
    <input id="subject" />

    <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
    <input id="note" />

    <button type="button" id="saveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

  </form>

  <hr style="margin:20px 0"/>

  <input type="text" id="searchBox" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö / ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠)" style="width:100%;padding:10px;border-radius:10px"/>

  <div class="filter-row">
    <button id="filterAll">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button id="filterWait">‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠</button>
    <button id="filterPending">‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô</button>
    <button id="filterSigned">‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
    <button id="filterReturn">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
  </div>

  <table id="docTable">
    <thead>
      <tr>
        <th>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th>
        <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
        <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
        <th>‡∏î‡πà‡∏ß‡∏ô</th>
        <th>‡∏•‡∏±‡∏ö</th>
        <th>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="exportBtn">üì¶ Export Excel</button>

  <div id="dashboard">
    <h3>Dashboard</h3>
    <p id="dailyCount">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: -</p>
    <p id="monthlyCount">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: -</p>
  </div>

</main>

<!-- ‚úÖ Firestore -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, query,
  orderBy, onSnapshot, updateDoc, serverTimestamp,
  getDocs, doc, arrayUnion, limit
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";

/* ‚úÖ config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
const firebaseConfig = {
  apiKey: "AIzaSyDAYnOCUm4-QKlJGCLOGEGHsUf143K2swc",
  authDomain: "doc-receive-v3.firebaseapp.com",
  projectId: "doc-receive-v3",
  storageBucket: "doc-receive-v3.firebasestorage.app",
  messagingSenderId: "105318430473",
  appId: "1:105318430473:web:0023244038de907be685d8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const docsCol = collection(db, "incoming_docs");

const tbody = document.querySelector("#docTable tbody");
const btnSave = document.getElementById("saveBtn");
const searchBox = document.getElementById("searchBox");
const exportBtn = document.getElementById("exportBtn");

/* ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô */
async function generateRefNo() {
  const yearTH = new Date().getFullYear() + 543;
  const qLast = query(docsCol, orderBy("refno", "desc"), limit(1));
  const snap = await getDocs(qLast);
  let next = 1;

  if (!snap.empty) {
    const last = snap.docs[0].data().refno || "";
    const [seq, y] = (last + "").split("/");
    if (parseInt(y) === yearTH) {
      next = (parseInt(seq) || 0) + 1;
    }
  }
  return String(next).padStart(3, "0") + "/" + yearTH;
}

/* ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å */
btnSave.onclick = async () => {
  const date = document.getElementById("date").value;
  const time = document.getElementById("time").value;
  const subject = document.getElementById("subject").value.trim();
  const urgency = document.getElementById("urgency").value;
  const secret = document.getElementById("secret").value;
  const from = document.getElementById("from").value.trim();
  const note = document.getElementById("note").value.trim();

  if (!date || !time || !subject || !from) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  try {
    const refno = await generateRefNo();
    await addDoc(docsCol, {
      refno, date, time, subject, urgency, secret, from, note,
      status: "‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠",
      createdAt: serverTimestamp(),
      statusHistory: [
        { status: "‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠", updatedAt: serverTimestamp() }
      ]
    });

    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  } catch (e) {
    console.error(e);
    alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
};

/* ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
async function changeStatus(id, newStatus) {
  const ref = doc(db, "incoming_docs", id);
  try {
    await updateDoc(ref, {
      status: newStatus,
      statusHistory: arrayUnion({
        status: newStatus,
        updatedAt: serverTimestamp(),
      })
    });
    alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß");
  } catch (e) {
    console.error(e);
    alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
}
window.changeStatus = changeStatus;

/* ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
function loadData(filter = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") {
  const q = query(docsCol, orderBy("createdAt", "desc"));

  onSnapshot(q, (snap) => {
    let html = "";
    const keyword = searchBox.value.toLowerCase();

    snap.forEach((docSnap) => {
      const d = docSnap.data();
      if (filter !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" && d.status !== filter) return;

      if (keyword) {
        const text = `${d.refno} ${d.subject} ${d.from}`.toLowerCase();
        if (!text.includes(keyword)) return;
      }

      html += `
      <tr>
        <td>${d.refno}</td>
        <td>${d.date}</td>
        <td>${d.time}</td>
        <td>${d.subject}</td>
        <td>${d.urgency}</td>
        <td>${d.secret}</td>
        <td>${d.from}</td>
        <td>${d.status}</td>
        <td>${d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString("th-TH") : "-"}</td>
        <td>
          <select onchange="changeStatus('${docSnap.id}', this.value)">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
            <option value="‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠">‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠</option>
            <option value="‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô">‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô</option>
            <option value="‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß">‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</option>
          </select>
        </td>
      </tr>
      `;
    });

    tbody.innerHTML = html;
  });
}
loadData();

/* ‚úÖ filter */
filterAll.onclick = () => loadData("‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
filterWait.onclick = () => loadData("‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠");
filterPending.onclick = () => loadData("‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô");
filterSigned.onclick = () => loadData("‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
filterReturn.onclick = () => loadData("‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");

/* ‚úÖ export */
exportBtn.onclick = async () => {
  const snap = await getDocs(query(docsCol, orderBy("createdAt", "desc")));
  let rows = [];

  snap.forEach((docSnap) => {
    let d = docSnap.data();

    rows.push({
      ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö: d.refno,
      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö: d.date,
      ‡πÄ‡∏ß‡∏•‡∏≤: d.time,
      ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: d.subject,
      ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠: d.from,
      ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: d.status,
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: d.createdAt?.toDate?.().toLocaleString("th-TH") ?? "-",
    });
  });

  let wb = XLSX.utils.book_new();
  let ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "incoming_docs");
  XLSX.writeFile(wb, "incoming_docs.xlsx");

  alert("‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
};
</script>

</body>
</html>
