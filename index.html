<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</title>

  <style>
    body {
      font-family: "Prompt", sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #0d6efd;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
    }
    main {
      max-width: 1200px;
      margin: auto;
      padding: 1rem;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    label{
      font-size:14px;
      font-weight:600;
    }
    input,select,textarea{
      width:100%;
      padding:8px;
      font-size:14px;
      border:1px solid #ddd;
      border-radius:6px;
    }
    button{
      background:#0d6efd;
      color:white;
      border:none;
      padding:10px 18px;
      border-radius:6px;
      font-size:15px;
      cursor:pointer;
    }
    button:hover{opacity:0.9;}
    table {
      width:100%;
      border-collapse: collapse;
      margin-top:1rem;
      background:white;
    }
    th,td{
      border:1px solid #ddd;
      padding:10px;
      text-align:left;
      font-size:14px;
    }
    th{
      background:#f3f4f6;
    }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
    }
    .pill-wait{background:#e7f0ff;color:#0d6efd;}
    .pill-sign{background:#fff5e1;color:#b46900;}
    .pill-done{background:#e5ffe7;color:#008f12;}
    .pill-edit{background:#ffecec;color:#d00000;}

    .filter-bar{
      display:flex;
      gap:1rem;
      margin-top:1rem;
      flex-wrap:wrap;
    }

    .dash-box{
      display:inline-block;
      padding:12px 16px;
      border-radius:6px;
      background:white;
      border:2px solid #0d6efd;
      margin:0 8px 12px 0;
      font-weight:600;
    }
  </style>

</head>
<body>

<header>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ - V3</header>

<main>

  <!-- DASHBOARD -->
  <div>
    <div class="dash-box" id="dailyCount">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: - ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
    <div class="dash-box" id="monthlyCount">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: - ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
  </div>

  <!-- FORM -->
  <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h3>
  <div class="row">
    <div>
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</label>
      <input type="date" id="date">
    </div>
    <div>
      <label>‡πÄ‡∏ß‡∏•‡∏≤</label>
      <input type="time" id="time">
    </div>
    <div>
      <label>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
      <input type="text" id="subject" placeholder="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á">
    </div>
    <div>
      <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</label>
      <select id="urgency">
        <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
        <option value="‡∏î‡πà‡∏ß‡∏ô">‡∏î‡πà‡∏ß‡∏ô</option>
      </select>
    </div>
    <div>
      <label>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</label>
      <input type="text" id="from">
    </div>
    <div>
      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <input type="text" id="note">
    </div>
  </div>

  <button id="saveBtn" style="margin-top:1rem;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

  <!-- FILTER + SEARCH -->
  <div class="filter-bar">
    <select id="filterStatus">
      <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      <option value="‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠">‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠</option>
      <option value="‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô">‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô</option>
      <option value="‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß">‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
      <option value="‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</option>
    </select>

    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠ / ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö">

    <button id="exportBtn">üìÅ Export Excel</button>
  </div>

  <!-- TABLE -->
  <table id="docTable">
    <thead>
      <tr>
        <th>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th>
        <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
        <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
        <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</th>
        <th>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</th>
        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
        <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <!-- ========================= -->
  <!-- Part 2: Firebase + Logic  -->
  <!-- ========================= -->
  <script type="module">
    /* 1) Firebase Config (‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏î‡∏£‡∏µ‡∏°) */
    const firebaseConfig = {
      apiKey: "PASTE_API_KEY_HERE",
      authDomain: "PASTE_AUTH_DOMAIN_HERE",
      projectId: "PASTE_PROJECT_ID_HERE",
      storageBucket: "PASTE_STORAGE_BUCKET_HERE",
      appId: "PASTE_APP_ID_HERE",
    };

    /* 2) SDK Imports */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, onSnapshot, updateDoc, doc,
      getDocs, where, Timestamp, limit
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";

    /* 3) Init */
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const docsCol = collection(db, "incoming_docs");

    /* 4) DOM Refs */
    const tbody        = document.querySelector("#docTable tbody");
    const btnSave      = document.getElementById("saveBtn");
    const filterStatus = document.getElementById("filterStatus");
    const searchInput  = document.getElementById("searchInput");
    const dailyEl      = document.getElementById("dailyCount");
    const monthlyEl    = document.getElementById("monthlyCount");
    const exportBtn    = document.getElementById("exportBtn");

    /* 5) Utilities */
    const fmtDateTimeTH = (d) =>
      new Intl.DateTimeFormat("th-TH", { dateStyle: "short", timeStyle: "short" }).format(d);

    const statusPill = (s) => {
      const map = {
        "‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠": "pill pill-sign",
        "‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô": "pill pill-wait",
        "‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß": "pill pill-done",
        "‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç": "pill pill-edit",
      };
      return `<span class="${map[s] || "pill"}">${s || "-"}</span>`;
    };

    const statusIcon = (s) => {
      switch (s) {
        case "‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠": return "üü°";
        case "‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô": return "üîµ";
        case "‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß": return "üü¢";
        case "‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç": return "üî¥";
        default: return "‚ö™";
      }
    };

    /* 6) ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏Å‡∏•‡∏≤‡∏á) */
    async function generateRefNo() {
      const yearTH = new Date().getFullYear() + 543;
      // refno padding ‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô 001/2568 ‚Üí ‡∏à‡∏∂‡∏á‡∏™‡∏±‡πà‡∏á orderBy("refno","desc") ‡πÑ‡∏î‡πâ
      const qLast = query(docsCol, orderBy("refno", "desc"), limit(1));
      const snap  = await getDocs(qLast);

      let next = 1;
      if (!snap.empty) {
        const last = snap.docs[0].data().refno || "";
        const [seqStr, y] = last.split("/");
        if (parseInt(y) === yearTH) next = (parseInt(seqStr) || 0) + 1;
      }
      return `${String(next).padStart(3, "0")}/${yearTH}`;
    }

    /* 7) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
    btnSave.addEventListener("click", async () => {
      const date    = document.getElementById("date").value;
      const time    = document.getElementById("time").value;
      const subject = document.getElementById("subject").value.trim();
      const urgency = document.getElementById("urgency").value;
      const from    = document.getElementById("from").value.trim();
      const note    = document.getElementById("note").value.trim();

      if (!date || !time || !subject || !from) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤/‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        return;
      }

      try {
        const refno = await generateRefNo();
        await addDoc(docsCol, {
          refno, date, time, subject, urgency, from, note,
          status: "‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠",
          createdAt: serverTimestamp(),
        });
        // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        document.getElementById("date").value    = "";
        document.getElementById("time").value    = "";
        document.getElementById("subject").value = "";
        document.getElementById("from").value    = "";
        document.getElementById("note").value    = "";
        document.getElementById("urgency").value = "‡∏õ‡∏Å‡∏ï‡∏¥";
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
        updateDashboard();
      } catch (e) {
        console.error(e);
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
      }
    });

    /* 8) Render Table + Filter + Search */
    let cacheDocs = []; // { id, data, createdText }

    function renderTable() {
      const kw = (searchInput.value || "").trim().toLowerCase();
      const f  = (filterStatus.value || "").trim();

      tbody.innerHTML = "";
      cacheDocs
        .filter(({ data }) => !f || data.status === f)
        .filter(({ data }) => {
          if (!kw) return true;
          const refno   = (data.refno   || "").toLowerCase();
          const subject = (data.subject || "").toLowerCase();
          const from    = (data.from    || "").toLowerCase();
          return refno.includes(kw) || subject.includes(kw) || from.includes(kw);
        })
        .forEach(({ id, data, createdText }) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.refno || "-"}</td>
            <td>${data.date || "-"}</td>
            <td>${data.time || "-"}</td>
            <td>${data.subject || "-"}</td>
            <td>${data.urgency || "-"}</td>
            <td>${data.from || "-"}</td>
            <td>${data.note || "-"}</td>
            <td>${statusIcon(data.status)} ${statusPill(data.status)}</td>
            <td>
              <button onclick="updateStatus('${id}','‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô')">‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô</button>
              <button onclick="updateStatus('${id}','‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß')">‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
              <button onclick="updateStatus('${id}','‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç')">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </td>
            <td>${createdText}</td>
          `;
          tbody.appendChild(tr);
        });
    }

    filterStatus.addEventListener("change", renderTable);
    searchInput.addEventListener("input", renderTable);

    const qList = query(docsCol, orderBy("createdAt", "desc"));
    onSnapshot(qList, (snap) => {
      cacheDocs = [];
      snap.forEach((ds) => {
        const d = ds.data();
        const created = d.createdAt?.toDate?.() ? d.createdAt.toDate() : null;
        cacheDocs.push({
          id: ds.id,
          data: d,
          createdText: created ? fmtDateTimeTH(created) : "-",
        });
      });
      renderTable();
    });

    /* 9) Update ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ) */
    async function _updateStatus(id, newStatus) {
      try {
        await updateDoc(doc(db, "incoming_docs", id), { status: newStatus });
        updateDashboard();
      } catch (e) {
        console.error(e);
        alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
    }
    window.updateStatus = _updateStatus;

    /* 10) Export Excel */
    exportBtn.addEventListener("click", async () => {
      try {
        const snap = await getDocs(qList);
        const rows = [];
        snap.forEach((ds) => {
          const d = ds.data();
          const created = d.createdAt?.toDate?.()
            ? fmtDateTimeTH(d.createdAt.toDate()) : "-";
          rows.push({
            ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö: d.refno || "-",
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö: d.date || "-",
            ‡πÄ‡∏ß‡∏•‡∏≤: d.time || "-",
            ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: d.subject || "-",
            ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô: d.urgency || "-",
            ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠: d.from || "-",
            ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: d.note || "-",
            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: d.status || "-",
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: created,
          });
        });
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Docs");
        const filename = `incoming-docs-${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, filename);
        alert("‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      } catch (e) {
        console.error(e);
        alert("‚ùå Export ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
      }
    });

    /* 11) Dashboard (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô) */
    async function updateDashboard() {
      const now = new Date();
      const y = now.getFullYear(), m = now.getMonth();
      const startDay   = new Date(y, m, now.getDate(), 0, 0, 0);
      const startMonth = new Date(y, m, 1, 0, 0, 0);

      const qDay   = query(docsCol, where("createdAt", ">=", Timestamp.fromDate(startDay)));
      const qMonth = query(docsCol, where("createdAt", ">=", Timestamp.fromDate(startMonth)));

      const daySnap   = await getDocs(qDay);
      const monthSnap = await getDocs(qMonth);

      dailyEl.textContent   = `‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: ${daySnap.size} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á`;
      monthlyEl.textContent = `‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthSnap.size} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á`;
    }
    setInterval(updateDashboard, 5000);
    updateDashboard();
  </script>

</main>
</body>
</html>
