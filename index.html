<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî V2</title>
  <style>
    body{font-family:"Prompt",system-ui,-apple-system,Segoe UI,Roboto; background:#f6f7f9; margin:0}
    header{background:#0d6efd;color:#fff;padding:14px 18px;font-size:18px}
    main{max-width:1100px;margin:20px auto;background:#fff;padding:22px;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{font-size:14px;color:#333}
    input,select,textarea,button{width:100%;padding:10px;border:1px solid #dcdfe4;border-radius:10px;font-size:14px}
    button{background:#0d6efd;color:#fff;border:none;cursor:pointer}
    button:hover{opacity:.95}
    table{width:100%;border-collapse:collapse;margin-top:18px}
    th,td{border:1px solid #e9ecef;padding:10px;text-align:left;font-size:14px;vertical-align:top}
    th{background:#f3f4f6}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .pill.wait{background:#e7f0ff;color:#0d6efd}
    .pill.pending{background:#fff7e0;color:#b58100}
    .pill.signed{background:#e8f5e9;color:#198754}
    .pill.return{background:#fdecea;color:#dc3545}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
  </style>
</head>
<body>
  <header>üìë ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî Version 2</header>

  <main>
    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏£‡∏±‡∏ö -->
    <form id="docForm">
      <div class="row">
        <div>
          <label>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</label>
          <input type="text" id="refno" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001/2568" readonly />
        </div>
        <div>
          <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</label>
          <select id="urgency">
            <option>‡∏õ‡∏Å‡∏ï‡∏¥</option>
            <option>‡∏î‡πà‡∏ß‡∏ô</option>
            <option>‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
            <option>‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</label>
          <input type="date" id="date" />
        </div>
        <div>
          <label>‡πÄ‡∏ß‡∏•‡∏≤</label>
          <input type="time" id="time" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
          <input type="text" id="subject" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥..." />
        </div>
        <div>
          <label>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
          <input type="text" id="from" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏±‡∏ì‡∏ë‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ / ‡∏ô.‡∏™.‡∏ß‡∏¥‡∏†‡∏≤" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <input type="text" id="note" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"/>
        </div>
        <div>
          <label>&nbsp;</label>
          <button type="button" id="saveBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
      </div>
    </form>

    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
    <div style="margin-top:16px">
      <input type="text" id="searchBox" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö / ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠" style="width:100%;padding:10px;border:1px solid #dcdfe4;border-radius:10px;font-size:14px" />
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
    <table id="docTable">
      <thead>
        <tr>
          <th style="width:110px">‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</th>
          <th style="width:110px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th>
          <th style="width:90px">‡πÄ‡∏ß‡∏•‡∏≤</th>
          <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
          <th style="width:160px">‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠</th>
          <th style="width:100px">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</th>
          <th style="width:130px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th style="width:220px">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
          <th style="width:160px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
    <div class="toolbar">
      <button id="filterAll">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button id="filterWait">‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠</button>
      <button id="filterPending">‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô</button>
      <button id="filterSigned">‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
      <button id="filterReturn">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      <button id="exportBtn" style="margin-left:auto">Export Excel</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="margin-top:20px">
      <h3>Dashboard (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h3>
      <p id="dailyCount">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: -</p>
      <p id="monthlyCount">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: -</p>
    </div>
  </main>

  <script type="module">
    /* ======== 1) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase (‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Firebase Console) ======== */
    const firebaseConfig = {
     apiKey: "PASTE_API_KEY_HERE",
     authDomain: "PASTE_AUTH_DOMAIN_HERE",
     projectId: "PASTE_PROJECT_ID_HERE",
     storageBucket: "PASTE_STORAGE_BUCKET_HERE",
     appId: "PASTE_APP_ID_HERE",
};


    /* ======== SDK Imports ======== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, onSnapshot, updateDoc, doc,
      getDocs, where, Timestamp, limit
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    // SheetJS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export Excel
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";

    /* ======== 2) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase/Firestore ======== */
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const docsCol = collection(db, "incoming_docs");

    /* ======== 3) ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á (‡∏Å‡∏±‡∏ô‡∏ä‡∏ô) ======== */
    async function generateRefNo() {
      const year = new Date().getFullYear() + 543;
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ï‡∏≤‡∏° refno ‡∏ó‡∏µ‡πà padding ‡πÅ‡∏•‡πâ‡∏ß)
      const qLast = query(docsCol, orderBy("refno", "desc"), limit(1));
      const snapLast = await getDocs(qLast);
      let nextSeq = 1;
      if (!snapLast.empty) {
        const last = snapLast.docs[0].data().refno || "";
        const [seqStr, y] = last.split("/");
        if (parseInt(y) === year) nextSeq = parseInt(seqStr) + 1;
      }
      const seq = String(nextSeq).padStart(3, "0");
      return `${seq}/${year}`;
    }

    async function updateRefNoInput() {
      try {
        const ref = await generateRefNo();
        const inp = document.getElementById("refno");
        inp.value = ref;
        inp.readOnly = true;
      } catch (e) {
        console.error(e);
      }
    }

    /* ======== 4) ‡∏™‡πà‡∏ß‡∏ô DOM & ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡∏£‡∏≠‡∏á/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ======== */
    const form  = document.getElementById("docForm");
    const btn   = document.getElementById("saveBtn");
    const tbody = document.querySelector("#docTable tbody");
    let currentFilter = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
    let searchText = "";
    let allDocs = []; // {id, data, createdText}

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏µ
    function statusPill(text){
      const map = {
        "‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠":"pill pending",
        "‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô":"pill wait",
        "‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß":"pill signed",
        "‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç":"pill return"
      };
      return `<span class="${map[text]||'pill'}">${text||'-'}</span>`;
    }

    function colorStatusIcon(s){
      switch(s){
        case "‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠": return "üü°";
        case "‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô": return "üîµ";
        case "‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß": return "üü¢";
        case "‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç": return "üî¥";
        default: return "‚ö™";
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á+‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    function renderRows(){
      tbody.innerHTML = "";
      const kw = searchText.toLowerCase();

      allDocs
        .filter(({data}) => currentFilter === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || data.status === currentFilter)
        .filter(({data}) => {
          if (!kw) return true;
          const refno = (data.refno||"").toLowerCase();
          const subject = (data.subject||"").toLowerCase();
          const from = (data.from||"").toLowerCase();
          return refno.includes(kw) || subject.includes(kw) || from.includes(kw);
        })
        .forEach(({id, data, createdText}) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.refno || "-"}</td>
            <td>${data.date || "-"}</td>
            <td>${data.time || "-"}</td>
            <td>${data.subject || "-"}</td>
            <td>${data.from || "-"}</td>
            <td>${data.urgency || "-"}</td>
            <td>${colorStatusIcon(data.status)} ${statusPill(data.status)}</td>
            <td>
              <button onclick="updateStatus('${id}', '‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô')">‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô</button>
              <button onclick="updateStatus('${id}', '‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß')">‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
              <button onclick="updateStatus('${id}', '‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç')">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </td>
            <td>${createdText}</td>`;
          tbody.appendChild(tr);
        });
    }

    // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ updateStatus ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° (attach ‡∏ö‡∏ô window)
    window.updateStatus = async (id, newStatus) => {
      try {
        await updateDoc(doc(db, "incoming_docs", id), { status: newStatus });
        // update dashboard ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        updateDashboard();
      } catch (err) {
        console.error(err);
        alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
    };

    // ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    document.getElementById("filterAll").onclick     = ()=>{ currentFilter="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"; renderRows(); };
    document.getElementById("filterWait").onclick     = ()=>{ currentFilter="‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠"; renderRows(); };
    document.getElementById("filterPending").onclick  = ()=>{ currentFilter="‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô"; renderRows(); };
    document.getElementById("filterSigned").onclick   = ()=>{ currentFilter="‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß"; renderRows(); };
    document.getElementById("filterReturn").onclick   = ()=>{ currentFilter="‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"; renderRows(); };

    // ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    document.getElementById("searchBox").addEventListener("input", (e)=>{
      searchText = e.target.value.trim();
      renderRows();
    });

    /* ======== 5) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ======== */
    btn.addEventListener("click", async () => {
      const refno   = document.getElementById("refno").value.trim();
      const date    = document.getElementById("date").value;
      const time    = document.getElementById("time").value;
      const subject = document.getElementById("subject").value.trim();
      const urgency = document.getElementById("urgency").value;
      const from    = document.getElementById("from").value.trim();
      const note    = document.getElementById("note").value.trim();

      if (!refno) {
        alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        return;
      }
      if (!date || !time || !subject || !from) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤/‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        return;
      }
      try {
        await addDoc(docsCol, {
          refno, date, time, subject, urgency, from, note,
          status: "‡∏£‡∏≠‡πÄ‡∏™‡∏ô‡∏≠",
          createdAt: serverTimestamp()
        });
        form.reset();
        await updateRefNoInput(); // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
        updateDashboard();
      } catch (err) {
        console.error(err);
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
      }
    });

    /* ======== 6) ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ======== */
    const qList = query(docsCol, orderBy("createdAt", "desc"));
    onSnapshot(qList, (snap) => {
      allDocs = [];
      snap.forEach((docSnap) => {
        const d = docSnap.data();
        const created = d.createdAt?.toDate?.() ? d.createdAt.toDate() : null;
        const createdText = created
          ? new Intl.DateTimeFormat("th-TH", { dateStyle: "short", timeStyle: "short" }).format(created)
          : "-";
        allDocs.push({ id: docSnap.id, data: d, createdText });
      });
      renderRows();
    });

    /* ======== 7) Export Excel ======== */
    document.getElementById("exportBtn").addEventListener("click", async () => {
      try {
        const snapAll = await getDocs(qList);
        const rows = [];
        snapAll.forEach((docSnap) => {
          const d = docSnap.data();
          const created = d.createdAt?.toDate?.()
            ? new Intl.DateTimeFormat("th-TH", { dateStyle:"short", timeStyle:"short" }).format(d.createdAt.toDate())
            : "-";
          rows.push({
            ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö: d.refno || "-",
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö: d.date || "-",
            ‡πÄ‡∏ß‡∏•‡∏≤: d.time || "-",
            ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: d.subject || "-",
            ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠: d.from || "-",
            ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô: d.urgency || "-",
            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: d.status || "-",
            ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: d.note || "-",
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: created,
          });
        });
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Docs");
        const filename = `incoming-docs-${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, filename);
        alert("‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      } catch (err) {
        console.error(err);
        alert("‚ùå Export ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
      }
    });

    /* ======== 8) Dashboard (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô) ======== */
    async function updateDashboard() {
      const now = new Date();
      const y = now.getFullYear(), m = now.getMonth();
      const startDay   = new Date(y, m, now.getDate(), 0, 0, 0);
      const startMonth = new Date(y, m, 1, 0, 0, 0);

      const qDay   = query(docsCol, where("createdAt", ">=", Timestamp.fromDate(startDay)));
      const qMonth = query(docsCol, where("createdAt", ">=", Timestamp.fromDate(startMonth)));

      const daySnap   = await getDocs(qDay);
      const monthSnap = await getDocs(qMonth);

      document.getElementById("dailyCount").textContent   = `‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: ${daySnap.size} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á`;
      document.getElementById("monthlyCount").textContent = `‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthSnap.size} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á`;
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dashboard ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ + ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
    setInterval(updateDashboard, 5000);
    updateDashboard();
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    updateRefNoInput();
  </script>
</body>
</html>
